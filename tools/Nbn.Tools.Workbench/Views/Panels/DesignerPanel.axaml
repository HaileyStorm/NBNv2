<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:shapes="clr-namespace:Avalonia.Controls.Shapes;assembly=Avalonia.Controls"
             xmlns:vm="clr-namespace:Nbn.Tools.Workbench.ViewModels"
             x:Class="Nbn.Tools.Workbench.Views.Panels.DesignerPanel"
             x:DataType="vm:DesignerPanelViewModel">
  <Border Classes="card">
    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
      <StackPanel Spacing="14">
        <StackPanel Spacing="6">
          <TextBlock Text="Designer" Classes="card-title" />
          <TextBlock Text="Sketch brain definitions, import/export .nbn, and validate constraints." Classes="card-subtitle" />
          <WrapPanel Orientation="Horizontal">
            <Button Content="New Brain" Command="{Binding NewBrainCommand}" Margin="0,0,8,8" />
            <Button Content="New Random Brain" Command="{Binding NewRandomBrainCommand}" Margin="0,0,8,8" />
            <Button Content="{Binding ResetBrainButtonLabel}"
                    Command="{Binding ResetBrainCommand}"
                    IsEnabled="{Binding CanResetBrain}"
                    Background="{Binding ResetBrainButtonBackground}"
                    Foreground="{Binding ResetBrainButtonForeground}"
                    BorderBrush="{Binding ResetBrainButtonBorder}"
                    ToolTip.Tip="Resets the design (keeps input/output). If changes are not exported, confirmation is required."
                    Margin="0,0,8,8" />
          </WrapPanel>
          <WrapPanel Orientation="Horizontal">
            <Button Content="Import .nbn" Command="{Binding ImportNbnCommand}" Margin="0,0,8,8" />
            <Button Content="Import .nbs" Command="{Binding ImportNbsCommand}" Margin="0,0,8,8" />
            <Button Content="Export" Command="{Binding ExportCommand}" Margin="0,0,8,8" />
            <Button Content="Export Snapshot" Command="{Binding ExportSnapshotCommand}" IsEnabled="{Binding CanExportSnapshot}" Margin="0,0,8,8" />
            <Button Content="Validate" Command="{Binding ValidateCommand}" Margin="0,0,8,8" />
          </WrapPanel>
          <StackPanel Spacing="2">
            <TextBlock Text="{Binding LoadedSummary}" Classes="muted" />
            <TextBlock Text="{Binding Status}" Classes="muted" />
          </StackPanel>
          <Border Classes="row">
            <StackPanel Spacing="6">
              <TextBlock Text="Validation" Classes="card-subtitle" />
              <TextBlock Text="{Binding ValidationSummary}" Classes="muted" />
              <ScrollViewer MaxHeight="200" VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding ValidationIssues}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding}" TextWrapping="Wrap" Classes="row-title" />
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
            </StackPanel>
          </Border>
        </StackPanel>

        <Grid ColumnDefinitions="300,2*,360" ColumnSpacing="14">
          <StackPanel Grid.Column="0" Spacing="12">
            <Border Classes="row">
              <StackPanel Spacing="8">
                <TextBlock Text="Brain Setup" Classes="row-title" />
                <TextBlock Text="{Binding DesignHint}" Classes="muted" />
                <StackPanel IsVisible="{Binding IsDesignVisible}" Spacing="8">
                  <StackPanel Spacing="4">
                    <TextBlock Text="Name" Classes="muted" />
                    <TextBox Text="{Binding Brain.Name}" />
                  </StackPanel>
                  <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <StackPanel Grid.Column="0" Spacing="4">
                      <TextBlock Text="Brain Id" Classes="muted" />
                      <TextBox Text="{Binding Brain.BrainIdText}" />
                    </StackPanel>
                    <Button Grid.Column="1" VerticalAlignment="Bottom" Content="New ID" Command="{Binding RandomizeBrainIdCommand}" />
                  </Grid>
                  <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <StackPanel Grid.Column="0" Spacing="4">
                      <TextBlock Text="Brain Seed" Classes="muted"
                                 ToolTip.Tip="Seed used for deterministic randomness (random generation, reproduction, plasticity)." />
                      <TextBox Text="{Binding Brain.BrainSeedText}" />
                    </StackPanel>
                    <Button Grid.Column="1" VerticalAlignment="Bottom" Content="Randomize" Command="{Binding RandomizeSeedCommand}" />
                  </Grid>
                  <TextBlock Text="Same seed yields repeatable random brains and reproduction outcomes." Classes="muted" />
                  <StackPanel Spacing="4">
                    <TextBlock Text="Axon Stride" Classes="muted" />
                    <TextBox Text="{Binding Brain.AxonStrideText}" />
                  </StackPanel>
                </StackPanel>
              </StackPanel>
            </Border>

            <Border Classes="row">
              <StackPanel Spacing="8">
                <TextBlock Text="Random Brain" Classes="row-title" />
                <TextBlock Text="Generate randomized brain definitions (advanced options are staged below)." Classes="muted" TextWrapping="Wrap" />
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="Regions" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding RandomOptions.RegionCountText}" />
                  <TextBlock Grid.Column="2" Text="(non-IO)" Classes="muted" VerticalAlignment="Center" />
                </Grid>
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="Neurons" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding RandomOptions.NeuronCountText}" />
                  <TextBlock Grid.Column="2" Text="per region" Classes="muted" VerticalAlignment="Center" />
                </Grid>
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="Axons" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding RandomOptions.AxonCountText}" />
                  <TextBlock Grid.Column="2" Text="per neuron" Classes="muted" VerticalAlignment="Center" />
                </Grid>
                <Grid ColumnDefinitions="Auto,*,Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="Input" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding RandomOptions.InputNeuronCountText}" Watermark="1-10" />
                  <TextBlock Grid.Column="2" Text="Output" VerticalAlignment="Center" />
                  <TextBox Grid.Column="3" Text="{Binding RandomOptions.OutputNeuronCountText}" Watermark="1-10" />
                  <TextBlock Grid.Column="4" Text="neurons" Classes="muted" VerticalAlignment="Center" />
                </Grid>
                <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                  <TextBlock Text="Seed" VerticalAlignment="Center" />
                  <ComboBox Grid.Column="1" ItemsSource="{Binding RandomOptions.SeedModes}" SelectedItem="{Binding RandomOptions.SelectedSeedMode}" Width="140">
                    <ComboBox.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Label}" />
                      </DataTemplate>
                    </ComboBox.ItemTemplate>
                  </ComboBox>
                  <TextBox Grid.Column="2" Text="{Binding RandomOptions.SeedText}" Width="140" IsEnabled="{Binding RandomOptions.IsSeedTextEnabled}" />
                </Grid>
                <WrapPanel Orientation="Horizontal">
                  <CheckBox Content="Allow self loops" IsChecked="{Binding RandomOptions.AllowSelfLoops}" Margin="0,0,12,0" />
                  <CheckBox Content="Allow intra-region" IsChecked="{Binding RandomOptions.AllowIntraRegion}" Margin="0,0,12,0" />
                  <CheckBox Content="Allow inter-region" IsChecked="{Binding RandomOptions.AllowInterRegion}" />
                </WrapPanel>
                <Grid ColumnDefinitions="Auto,*,Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="Strength" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding RandomOptions.StrengthMinText}" />
                  <TextBlock Grid.Column="2" Text="to" Classes="muted" VerticalAlignment="Center" />
                  <TextBox Grid.Column="3" Text="{Binding RandomOptions.StrengthMaxText}" />
                  <TextBlock Grid.Column="4" Text="(code)" Classes="muted" VerticalAlignment="Center" />
                </Grid>
                <Expander Header="Advanced options" IsExpanded="False">
                  <StackPanel Margin="0,6,0,0" Spacing="8">
                    <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Region mode" VerticalAlignment="Center" />
                      <ComboBox Grid.Column="1" ItemsSource="{Binding RandomOptions.RegionSelectionModes}" SelectedItem="{Binding RandomOptions.SelectedRegionSelectionMode}" Width="160">
                        <ComboBox.ItemTemplate>
                          <DataTemplate>
                            <TextBlock Text="{Binding Label}" />
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>
                      <TextBox Grid.Column="2" Text="{Binding RandomOptions.RegionListText}" Width="140"
                               IsEnabled="{Binding RandomOptions.IsRegionListEnabled}" Watermark="1,2,3" />
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Neuron mode" VerticalAlignment="Center" />
                      <ComboBox Grid.Column="1" ItemsSource="{Binding RandomOptions.NeuronCountModes}" SelectedItem="{Binding RandomOptions.SelectedNeuronCountMode}" Width="110">
                        <ComboBox.ItemTemplate>
                          <DataTemplate>
                            <TextBlock Text="{Binding Label}" />
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>
                      <TextBox Grid.Column="2" Text="{Binding RandomOptions.NeuronCountMinText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsNeuronRangeEnabled}" />
                      <TextBlock Grid.Column="3" Text="to" Classes="muted" VerticalAlignment="Center" />
                      <TextBox Grid.Column="4" Text="{Binding RandomOptions.NeuronCountMaxText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsNeuronRangeEnabled}" />
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Axon mode" VerticalAlignment="Center" />
                      <ComboBox Grid.Column="1" ItemsSource="{Binding RandomOptions.AxonCountModes}" SelectedItem="{Binding RandomOptions.SelectedAxonCountMode}" Width="110">
                        <ComboBox.ItemTemplate>
                          <DataTemplate>
                            <TextBlock Text="{Binding Label}" />
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>
                      <TextBox Grid.Column="2" Text="{Binding RandomOptions.AxonCountMinText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsAxonRangeEnabled}" />
                      <TextBlock Grid.Column="3" Text="to" Classes="muted" VerticalAlignment="Center" />
                      <TextBox Grid.Column="4" Text="{Binding RandomOptions.AxonCountMaxText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsAxonRangeEnabled}" />
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Target bias" VerticalAlignment="Center" />
                      <ComboBox Grid.Column="1" ItemsSource="{Binding RandomOptions.TargetBiasModes}" SelectedItem="{Binding RandomOptions.SelectedTargetBiasMode}" Width="160">
                        <ComboBox.ItemTemplate>
                          <DataTemplate>
                            <TextBlock Text="{Binding Label}" />
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Strength dist" VerticalAlignment="Center" />
                      <ComboBox Grid.Column="1" ItemsSource="{Binding RandomOptions.StrengthDistributions}" SelectedItem="{Binding RandomOptions.SelectedStrengthDistribution}" Width="160">
                        <ComboBox.ItemTemplate>
                          <DataTemplate>
                            <TextBlock Text="{Binding Label}" />
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Activation" VerticalAlignment="Center" />
                      <ComboBox Grid.Column="1" ItemsSource="{Binding RandomOptions.ActivationModes}" SelectedItem="{Binding RandomOptions.SelectedActivationMode}" Width="130">
                        <ComboBox.ItemTemplate>
                          <DataTemplate>
                            <TextBlock Text="{Binding Label}" />
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>
                      <TextBox Grid.Column="2" Text="{Binding RandomOptions.ActivationFixedIdText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsActivationFixedEnabled}" />
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Reset" VerticalAlignment="Center" />
                      <ComboBox Grid.Column="1" ItemsSource="{Binding RandomOptions.ResetModes}" SelectedItem="{Binding RandomOptions.SelectedResetMode}" Width="130">
                        <ComboBox.ItemTemplate>
                          <DataTemplate>
                            <TextBlock Text="{Binding Label}" />
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>
                      <TextBox Grid.Column="2" Text="{Binding RandomOptions.ResetFixedIdText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsResetFixedEnabled}" />
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Accumulation" VerticalAlignment="Center" />
                      <ComboBox Grid.Column="1" ItemsSource="{Binding RandomOptions.AccumulationModes}" SelectedItem="{Binding RandomOptions.SelectedAccumulationMode}" Width="130">
                        <ComboBox.ItemTemplate>
                          <DataTemplate>
                            <TextBlock Text="{Binding Label}" />
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>
                      <TextBox Grid.Column="2" Text="{Binding RandomOptions.AccumulationFixedIdText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsAccumulationFixedEnabled}" />
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Threshold mode" VerticalAlignment="Center" />
                      <ComboBox Grid.Column="1" ItemsSource="{Binding RandomOptions.ThresholdModes}" SelectedItem="{Binding RandomOptions.SelectedThresholdMode}" Width="130">
                        <ComboBox.ItemTemplate>
                          <DataTemplate>
                            <TextBlock Text="{Binding Label}" />
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Pre-act" VerticalAlignment="Center" />
                      <TextBox Grid.Column="1" Text="{Binding RandomOptions.PreActivationMinText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsThresholdRangeEnabled}" />
                      <TextBlock Grid.Column="2" Text="to" Classes="muted" VerticalAlignment="Center" />
                      <TextBox Grid.Column="3" Text="{Binding RandomOptions.PreActivationMaxText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsThresholdRangeEnabled}" />
                      <TextBlock Grid.Column="4" Text="code" Classes="muted" VerticalAlignment="Center" />
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Act thresh" VerticalAlignment="Center" />
                      <TextBox Grid.Column="1" Text="{Binding RandomOptions.ActivationThresholdMinText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsThresholdRangeEnabled}" />
                      <TextBlock Grid.Column="2" Text="to" Classes="muted" VerticalAlignment="Center" />
                      <TextBox Grid.Column="3" Text="{Binding RandomOptions.ActivationThresholdMaxText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsThresholdRangeEnabled}" />
                      <TextBlock Grid.Column="4" Text="code" Classes="muted" VerticalAlignment="Center" />
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Param mode" VerticalAlignment="Center" />
                      <ComboBox Grid.Column="1" ItemsSource="{Binding RandomOptions.ParamModes}" SelectedItem="{Binding RandomOptions.SelectedParamMode}" Width="130">
                        <ComboBox.ItemTemplate>
                          <DataTemplate>
                            <TextBlock Text="{Binding Label}" />
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Param A" VerticalAlignment="Center" />
                      <TextBox Grid.Column="1" Text="{Binding RandomOptions.ParamAMinText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsParamRangeEnabled}" />
                      <TextBlock Grid.Column="2" Text="to" Classes="muted" VerticalAlignment="Center" />
                      <TextBox Grid.Column="3" Text="{Binding RandomOptions.ParamAMaxText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsParamRangeEnabled}" />
                      <TextBlock Grid.Column="4" Text="code" Classes="muted" VerticalAlignment="Center" />
                    </Grid>
                    <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="8">
                      <TextBlock Text="Param B" VerticalAlignment="Center" />
                      <TextBox Grid.Column="1" Text="{Binding RandomOptions.ParamBMinText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsParamRangeEnabled}" />
                      <TextBlock Grid.Column="2" Text="to" Classes="muted" VerticalAlignment="Center" />
                      <TextBox Grid.Column="3" Text="{Binding RandomOptions.ParamBMaxText}" Width="70"
                               IsEnabled="{Binding RandomOptions.IsParamRangeEnabled}" />
                      <TextBlock Grid.Column="4" Text="code" Classes="muted" VerticalAlignment="Center" />
                    </Grid>
                  </StackPanel>
                </Expander>
                <Button Content="Generate Random Brain" Command="{Binding NewRandomBrainCommand}" />
              </StackPanel>
            </Border>

            <Border Classes="row">
              <StackPanel Spacing="8">
                <TextBlock Text="Regions" Classes="row-title" />
                <TextBlock Text="Click a region to focus edits." Classes="muted" />
                <ItemsControl ItemsSource="{Binding Brain.Regions}">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <WrapPanel Orientation="Horizontal" />
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="vm:DesignerRegionViewModel" x:CompileBindings="False">
                      <Button Command="{Binding DataContext.SelectRegionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                              CommandParameter="{Binding}"
                              Background="{Binding SelectionBackground}"
                              BorderBrush="{Binding SelectionBorder}"
                              Foreground="{Binding SelectionForeground}"
                              BorderThickness="1"
                              CornerRadius="8"
                              Margin="4"
                              Opacity="{Binding TileOpacity}">
                        <StackPanel Spacing="2">
                          <TextBlock Text="{Binding Label}" FontWeight="SemiBold" />
                          <TextBlock Text="{Binding Detail}" Classes="muted" />
                        </StackPanel>
                      </Button>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </StackPanel>
            </Border>

            <Border Classes="row" IsVisible="{Binding IsDesignVisible}">
              <StackPanel Spacing="8">
                <TextBlock Text="Region Tools" Classes="row-title" />
                <TextBlock Text="{Binding SelectedRegionLabel}" Classes="muted" />
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="Neuron Count" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding RegionSizeText}" />
                  <Button Grid.Column="2" Content="Apply" Command="{Binding ApplyRegionSizeCommand}" />
                </Grid>
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="Jump To" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding JumpNeuronIdText}" />
                  <Button Grid.Column="2" Content="Go" Command="{Binding JumpToNeuronCommand}" />
                </Grid>
              </StackPanel>
            </Border>

            <Border Classes="row" IsVisible="{Binding IsDesignVisible}">
              <StackPanel Spacing="8">
                <TextBlock Text="Snapshot Defaults" Classes="row-title" />
                <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                  <StackPanel Grid.Column="0" Spacing="4">
                    <TextBlock Text="Snapshot tick id (header only)" Classes="muted"
                               ToolTip.Tip="Stored in the .nbs header for reference; use 0 if unknown." />
                    <TextBox Text="{Binding SnapshotTickText}" />
                  </StackPanel>
                  <StackPanel Grid.Column="1" Spacing="4">
                    <TextBlock Text="Energy" Classes="muted" />
                    <TextBox Text="{Binding SnapshotEnergyText}" />
                  </StackPanel>
                </Grid>
                <TextBlock Text="Header tick is informational only and does not advance the sim." Classes="muted" TextWrapping="Wrap" />
                <CheckBox Content="Include enabled bitset" IsChecked="{Binding SnapshotIncludeEnabledBitset}" />
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <CheckBox Content="Cost + Energy" IsChecked="{Binding SnapshotCostEnergyEnabled}"
                            ToolTip.Tip="Sets both cost_enabled and energy_enabled flags in the snapshot header." />
                  <CheckBox Content="Plasticity" IsChecked="{Binding SnapshotPlasticityEnabled}" />
                </StackPanel>
              </StackPanel>
            </Border>

            <Border Classes="row" IsVisible="{Binding IsDesignVisible}">
              <StackPanel Spacing="8">
                <TextBlock Text="Spawn Options" Classes="row-title" />
                <TextBlock Text="Requires Settings, HiveMind, and IO connections." Classes="muted" />
                <Button Content="Spawn Brain"
                        Command="{Binding SpawnBrainCommand}"
                        IsEnabled="{Binding CanSpawnBrain}"
                        Classes="accent"
                        HorizontalAlignment="Left" />
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="Bind host" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding SpawnBindHost}" />
                  <TextBlock Grid.Column="2" Text="local" Classes="muted" VerticalAlignment="Center" />
                </Grid>
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="BrainHost port" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding SpawnBrainPortText}" />
                </Grid>
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="RegionHost base" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding SpawnRegionPortText}" />
                  <TextBlock Grid.Column="2" Text="port" Classes="muted" VerticalAlignment="Center" />
                </Grid>
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                  <TextBlock Text="Placement" VerticalAlignment="Center" />
                  <ComboBox Grid.Column="1"
                            ItemsSource="{Binding SpawnPlacementOptions}"
                            SelectedItem="{Binding SelectedSpawnPlacement}">
                    <ComboBox.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Label}" />
                      </DataTemplate>
                    </ComboBox.ItemTemplate>
                  </ComboBox>
                </Grid>
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                  <TextBlock Text="RegionHost policy" VerticalAlignment="Center" />
                  <ComboBox Grid.Column="1"
                            ItemsSource="{Binding RegionHostPolicies}"
                            SelectedItem="{Binding SelectedRegionHostPolicy}">
                    <ComboBox.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Label}" />
                      </DataTemplate>
                    </ComboBox.ItemTemplate>
                  </ComboBox>
                </Grid>
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                  <TextBlock Text="Shard plan" VerticalAlignment="Center" />
                  <ComboBox Grid.Column="1"
                            ItemsSource="{Binding ShardPlanOptions}"
                            SelectedItem="{Binding SelectedShardPlan}">
                    <ComboBox.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Label}" />
                      </DataTemplate>
                    </ComboBox.ItemTemplate>
                  </ComboBox>
                </Grid>
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="RegionHost count" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding SpawnRegionHostCountText}" />
                  <TextBlock Grid.Column="2" Text="0=auto" Classes="muted" VerticalAlignment="Center" />
                </Grid>
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="Shards per region" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding SpawnShardCountText}" />
                  <TextBlock Grid.Column="2" Text="0=auto (non-IO)" Classes="muted" VerticalAlignment="Center" />
                </Grid>
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                  <TextBlock Text="Max neurons/shard" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding SpawnShardTargetNeuronsText}" />
                  <TextBlock Grid.Column="2" Text="0=auto (non-IO)" Classes="muted" VerticalAlignment="Center" />
                </Grid>
                <StackPanel Spacing="4">
                  <TextBlock Text="Artifact root" Classes="muted" />
                  <TextBox Text="{Binding SpawnArtifactRoot}" />
                </StackPanel>
              </StackPanel>
            </Border>
          </StackPanel>

          <Border Grid.Column="1" Classes="row" IsVisible="{Binding IsDesignVisible}">
            <Grid RowDefinitions="Auto,Auto,Auto,*,Auto,Auto" RowSpacing="10">
              <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="8">
                <StackPanel Grid.Column="0">
                  <TextBlock Text="Workspace" Classes="row-title" />
                  <TextBlock Text="{Binding SelectedRegionLabel}" Classes="muted" />
                </StackPanel>
                <Button Grid.Column="1" Content="Add Neuron" Command="{Binding AddNeuronCommand}" />
                <Button Grid.Column="2"
                        Content="{Binding AxonLinkButtonLabel}"
                        Command="{Binding ToggleAxonLinkModeCommand}"
                        Background="{Binding AxonLinkButtonBackground}"
                        Foreground="{Binding AxonLinkButtonForeground}"
                        BorderBrush="{Binding AxonLinkButtonBorder}" />
                <Button Grid.Column="3" Content="Clear" Command="{Binding ClearSelectionCommand}" />
              </Grid>

              <WrapPanel Grid.Row="1" Orientation="Horizontal" ItemHeight="28" Margin="0,0,0,2">
                <Border Classes="chip" BorderBrush="{DynamicResource NbnBorderBrush}" Background="{DynamicResource NbnSurfaceAltBrush}" Margin="0,0,8,4">
                  <TextBlock Text="{Binding AxonLinkStatus}" />
                </Border>
                <Border Classes="chip" BorderBrush="{DynamicResource NbnBorderBrush}" Background="{DynamicResource NbnSurfaceAltBrush}" Margin="0,0,8,4">
                  <TextBlock Text="Outbound (internal) = orange" Classes="muted" />
                </Border>
                <Border Classes="chip" BorderBrush="{DynamicResource NbnBorderBrush}" Background="{DynamicResource NbnSurfaceAltBrush}" Margin="0,0,8,4">
                  <TextBlock Text="Inbound (internal) = teal" Classes="muted" />
                </Border>
                <Border Classes="chip" BorderBrush="{DynamicResource NbnBorderBrush}" Background="{DynamicResource NbnSurfaceAltBrush}" Margin="0,0,8,4">
                  <TextBlock Text="External/off-page = gold + gray labels" Classes="muted" />
                </Border>
              </WrapPanel>

              <Grid Grid.Row="2" ColumnDefinitions="Auto,*,60,Auto,*,60" ColumnSpacing="8" RowDefinitions="Auto,Auto" RowSpacing="8">
                <TextBlock Grid.Row="0" Grid.Column="0" Text="Link Strength" VerticalAlignment="Center" />
                <Slider Grid.Row="0" Grid.Column="1" Minimum="0" Maximum="31" Value="{Binding DefaultAxonStrength}" />
                <TextBox Grid.Row="0" Grid.Column="2" Text="{Binding DefaultAxonStrength}" />

                <TextBlock Grid.Row="0" Grid.Column="3" Text="Zoom" VerticalAlignment="Center" />
                <Slider Grid.Row="0" Grid.Column="4" Minimum="0.5" Maximum="2.5" Value="{Binding CanvasZoom}" />
                <TextBox Grid.Row="0" Grid.Column="5" Text="{Binding CanvasZoomText}" />

                <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3" Orientation="Horizontal" Spacing="6">
                  <Button Content="First" Command="{Binding FirstRegionPageCommand}" />
                  <Button Content="Prev" Command="{Binding PreviousRegionPageCommand}" />
                  <Button Content="Next" Command="{Binding NextRegionPageCommand}" />
                  <Button Content="Last" Command="{Binding LastRegionPageCommand}" />
                </StackPanel>

                <Grid Grid.Row="1" Grid.Column="3" Grid.ColumnSpan="3" ColumnDefinitions="Auto,60,Auto,60,Auto,*" ColumnSpacing="6">
                  <TextBlock Text="Page" VerticalAlignment="Center" />
                  <TextBox Grid.Column="1" Text="{Binding RegionPageIndexText}" />
                  <TextBlock Grid.Column="2" Text="/" VerticalAlignment="Center" />
                  <TextBlock Grid.Column="3" Text="{Binding RegionPageCount}" VerticalAlignment="Center" />
                  <TextBlock Grid.Column="4" Text="Size" VerticalAlignment="Center" />
                  <TextBox Grid.Column="5" Text="{Binding RegionPageSizeText}" />
                </Grid>
              </Grid>

              <Border Grid.Row="3"
                      BorderBrush="{DynamicResource NbnBorderBrush}"
                      BorderThickness="1"
                      CornerRadius="10"
                      Background="{DynamicResource NbnSurfaceBrush}"
                      Padding="6"
                      MinHeight="620">
                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                  <Grid Width="{Binding CanvasWidth}" Height="{Binding CanvasHeight}">
                    <ItemsControl ItemsSource="{Binding VisibleEdges}">
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <Canvas />
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>
                      <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="vm:DesignerEdgeViewModel" x:CompileBindings="False">
                          <Canvas>
                            <shapes:Path Data="{Binding PathGeometry}"
                                         Stroke="{Binding Stroke}"
                                         StrokeThickness="{Binding Thickness}" />
                            <shapes:Path Data="{Binding ArrowHeadGeometry}"
                                         IsVisible="{Binding ShowArrowHead}"
                                         Fill="{Binding Stroke}"
                                         Stroke="{Binding Stroke}"
                                         StrokeThickness="0.8" />
                          </Canvas>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <ItemsControl ItemsSource="{Binding VisibleNeurons}">
                      <ItemsControl.ItemContainerTheme>
                        <ControlTheme TargetType="ContentPresenter" x:CompileBindings="False">
                          <Setter Property="Canvas.Left" Value="{Binding CanvasX}" />
                          <Setter Property="Canvas.Top" Value="{Binding CanvasY}" />
                        </ControlTheme>
                      </ItemsControl.ItemContainerTheme>
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <Canvas />
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>
                      <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="vm:DesignerNeuronViewModel" x:CompileBindings="False">
                          <Button Width="{Binding DataContext.CanvasNodeSize, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                  Height="{Binding DataContext.CanvasNodeSize, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                  Command="{Binding DataContext.SelectNeuronCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                  CommandParameter="{Binding}"
                                  Background="{Binding TileBackground}"
                                  BorderBrush="{Binding TileBorder}"
                                  Foreground="{Binding TileForeground}"
                                  BorderThickness="1"
                                  CornerRadius="8"
                                  Padding="2"
                                  Opacity="{Binding TileOpacity}"
                                  PointerEntered="NeuronPointerEntered"
                                  PointerExited="NeuronPointerExited">
                            <TextBlock Text="{Binding TileLabel}" HorizontalAlignment="Center" VerticalAlignment="Center" />
                          </Button>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <ItemsControl ItemsSource="{Binding VisibleEdges}">
                      <ItemsControl.ItemContainerTheme>
                        <ControlTheme TargetType="ContentPresenter" x:CompileBindings="False">
                          <Setter Property="Canvas.Left" Value="{Binding LabelPosition.X}" />
                          <Setter Property="Canvas.Top" Value="{Binding LabelPosition.Y}" />
                        </ControlTheme>
                      </ItemsControl.ItemContainerTheme>
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <Canvas />
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>
                      <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="vm:DesignerEdgeViewModel" x:CompileBindings="False">
                          <Button Content="{Binding Label}"
                                  IsVisible="{Binding HasLabel}"
                                  IsEnabled="{Binding CanNavigate}"
                                  Command="{Binding DataContext.FocusEdgeEndpointCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                  CommandParameter="{Binding}"
                                  ToolTip.Tip="{Binding NavigationHint}"
                                  Background="Transparent"
                                  BorderBrush="Transparent"
                                  Foreground="{DynamicResource NbnMutedBrush}"
                                  FontSize="10"
                                  Padding="1" />
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </Grid>
                </ScrollViewer>
              </Border>

              <Grid Grid.Row="4" ColumnDefinitions="*,Auto" ColumnSpacing="12">
                <StackPanel Grid.Column="0" Spacing="2">
                  <TextBlock Text="{Binding EdgeSummary}" Classes="muted" />
                  <TextBlock Text="{Binding EdgeAnalyticsSummary}" Classes="muted" TextWrapping="Wrap" />
                </StackPanel>
                <TextBlock Grid.Column="1" Text="{Binding RegionPageSummary}" Classes="muted" VerticalAlignment="Top" />
              </Grid>

              <Expander Grid.Row="5" Header="Visible Neuron Tiles (compact list)" IsExpanded="False">
                <ItemsControl ItemsSource="{Binding VisibleNeurons}">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <WrapPanel Orientation="Horizontal" ItemWidth="120" ItemHeight="72" />
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="vm:DesignerNeuronViewModel" x:CompileBindings="False">
                      <Button Command="{Binding DataContext.SelectNeuronCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                              CommandParameter="{Binding}"
                              Background="{Binding TileBackground}"
                              BorderBrush="{Binding TileBorder}"
                              Foreground="{Binding TileForeground}"
                              BorderThickness="1"
                              CornerRadius="8"
                              Margin="4"
                              Padding="6"
                              Opacity="{Binding TileOpacity}"
                              PointerEntered="NeuronPointerEntered"
                              PointerExited="NeuronPointerExited">
                        <StackPanel Spacing="2">
                          <TextBlock Text="{Binding TileLabel}" FontWeight="SemiBold" />
                          <TextBlock Text="{Binding TileDetail}" Classes="muted" />
                        </StackPanel>
                      </Button>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </Expander>
            </Grid>
          </Border>

          <Border Grid.Column="2" Classes="row" IsVisible="{Binding IsDesignVisible}">
            <StackPanel Spacing="10">
              <TextBlock Text="Inspector" Classes="row-title" />
              <TextBlock Text="{Binding SelectedNeuronLabel}" Classes="muted" />

              <StackPanel IsVisible="{Binding HasNeuronSelection}" Spacing="10">
                <StackPanel Spacing="6">
                  <TextBlock Text="Functions" Classes="row-title" />
                  <TextBlock Text="{Binding FunctionLegend}" Classes="muted" TextWrapping="Wrap" />
                  <TextBlock Text="{Binding SelectedNeuronConstraintHint}" Classes="muted" TextWrapping="Wrap" />
                  <StackPanel Spacing="4">
                    <TextBlock Text="Activation" Classes="muted"
                               ToolTip.Tip="Activation computes potential from buffer B (and params)." />
                    <ComboBox ItemsSource="{Binding ActivationFunctions}"
                              SelectedIndex="{Binding SelectedNeuron.ActivationFunctionId}"
                              ToolTip.Tip="{Binding SelectedActivationDescription}">
                      <ComboBox.ItemTemplate>
                        <DataTemplate x:CompileBindings="False">
                          <TextBlock Text="{Binding Label}" ToolTip.Tip="{Binding Description}" />
                        </DataTemplate>
                      </ComboBox.ItemTemplate>
                    </ComboBox>
                    <TextBlock Text="{Binding SelectedActivationDescription}" Classes="muted" TextWrapping="Wrap" />
                  </StackPanel>
                  <StackPanel Spacing="4">
                    <TextBlock Text="Reset" Classes="muted"
                               ToolTip.Tip="Reset updates buffer after activation using potential P and threshold T." />
                    <ComboBox ItemsSource="{Binding ResetFunctions}"
                              SelectedIndex="{Binding SelectedNeuron.ResetFunctionId}"
                              ToolTip.Tip="{Binding SelectedResetDescription}">
                      <ComboBox.ItemTemplate>
                        <DataTemplate x:CompileBindings="False">
                          <TextBlock Text="{Binding Label}" ToolTip.Tip="{Binding Description}" />
                        </DataTemplate>
                      </ComboBox.ItemTemplate>
                    </ComboBox>
                    <TextBlock Text="{Binding SelectedResetDescription}" Classes="muted" TextWrapping="Wrap" />
                  </StackPanel>
                  <StackPanel Spacing="4">
                    <TextBlock Text="Accumulation" Classes="muted"
                               ToolTip.Tip="Accumulation merges inbox I into buffer B at tick start." />
                    <ComboBox ItemsSource="{Binding AccumulationFunctions}"
                              SelectedIndex="{Binding SelectedNeuron.AccumulationFunctionId}"
                              ToolTip.Tip="{Binding SelectedAccumulationDescription}">
                      <ComboBox.ItemTemplate>
                        <DataTemplate x:CompileBindings="False">
                          <TextBlock Text="{Binding Label}" ToolTip.Tip="{Binding Description}" />
                        </DataTemplate>
                      </ComboBox.ItemTemplate>
                    </ComboBox>
                    <TextBlock Text="{Binding SelectedAccumulationDescription}" Classes="muted" TextWrapping="Wrap" />
                  </StackPanel>
                </StackPanel>

                <StackPanel Spacing="6">
                  <TextBlock Text="Parameters" Classes="row-title" />
                  <Grid ColumnDefinitions="Auto,*,60" ColumnSpacing="8" RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="6">
                    <Grid Grid.Row="0" Grid.ColumnSpan="3" ColumnDefinitions="Auto,*,60" ColumnSpacing="8"
                          IsEnabled="{Binding SelectedNeuronUsesParamA}">
                      <TextBlock Text="Param A" VerticalAlignment="Center"
                                 ToolTip.Tip="Param A is used by some activation functions (see Activation description)." />
                      <Slider Grid.Column="1" Minimum="0" Maximum="63"
                              Value="{Binding SelectedNeuron.ParamACode}" />
                      <TextBox Grid.Column="2" Text="{Binding SelectedNeuron.ParamACode}" />
                    </Grid>

                    <Grid Grid.Row="1" Grid.ColumnSpan="3" ColumnDefinitions="Auto,*,60" ColumnSpacing="8"
                          IsEnabled="{Binding SelectedNeuronUsesParamB}">
                      <TextBlock Text="Param B" VerticalAlignment="Center"
                                 ToolTip.Tip="Param B is used by some activation functions (see Activation description)." />
                      <Slider Grid.Column="1" Minimum="0" Maximum="63"
                              Value="{Binding SelectedNeuron.ParamBCode}" />
                      <TextBox Grid.Column="2" Text="{Binding SelectedNeuron.ParamBCode}" />
                    </Grid>

                    <TextBlock Grid.Row="2" Text="Pre-Act Thresh" VerticalAlignment="Center"
                               ToolTip.Tip="Neuron activates only if buffer B exceeds this threshold." />
                    <Slider Grid.Row="2" Grid.Column="1" Minimum="0" Maximum="63" Value="{Binding SelectedNeuron.PreActivationThresholdCode}" />
                    <TextBox Grid.Row="2" Grid.Column="2" Text="{Binding SelectedNeuron.PreActivationThresholdCode}" />

                    <TextBlock Grid.Row="3" Text="Act Thresh" VerticalAlignment="Center"
                               ToolTip.Tip="Neuron fires when |potential| exceeds this threshold." />
                    <Slider Grid.Row="3" Grid.Column="1" Minimum="0" Maximum="63" Value="{Binding SelectedNeuron.ActivationThresholdCode}" />
                    <TextBox Grid.Row="3" Grid.Column="2" Text="{Binding SelectedNeuron.ActivationThresholdCode}" />
                  </Grid>
                  <TextBlock Text="{Binding ParameterHelp}" Classes="muted" TextWrapping="Wrap" />
                </StackPanel>

                <StackPanel Spacing="6">
                  <TextBlock Text="Neuron State" Classes="row-title" />
                  <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <TextBlock Text="{Binding SelectedNeuron.TileDetail}" Classes="muted" />
                    <Button Content="Toggle Enabled" Command="{Binding ToggleNeuronEnabledCommand}" />
                  </Grid>
                </StackPanel>

                <StackPanel Spacing="6">
                  <TextBlock Text="Outgoing Axons" Classes="row-title" />
                  <TextBlock Text="{Binding SelectedNeuron.TileDetail}" Classes="muted" />
                  <ItemsControl ItemsSource="{Binding SelectedNeuron.Axons}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate DataType="vm:DesignerAxonViewModel" x:CompileBindings="False">
                        <Button Command="{Binding DataContext.SelectAxonCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding}"
                                Background="{Binding RowBackground}"
                                Foreground="{Binding RowForeground}"
                                BorderBrush="{DynamicResource NbnBorderBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="6"
                                Margin="0,4">
                          <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Text="{Binding TargetLabel}" />
                            <TextBlock Grid.Column="1" Text="{Binding StrengthLabel}" />
                          </Grid>
                        </Button>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                  <Grid ColumnDefinitions="Auto,60,Auto,80,Auto" ColumnSpacing="6">
                    <TextBlock Text="R" VerticalAlignment="Center" />
                    <TextBox Grid.Column="1" Text="{Binding AxonTargetRegionText}" />
                    <TextBlock Grid.Column="2" Text="N" VerticalAlignment="Center" />
                    <TextBox Grid.Column="3" Text="{Binding AxonTargetNeuronText}" />
                    <Button Grid.Column="4" Content="Add" Command="{Binding AddAxonByIdCommand}" />
                  </Grid>
                  <Button Content="Remove Selected Axon" Command="{Binding RemoveAxonCommand}" />
                </StackPanel>
              </StackPanel>

              <StackPanel IsVisible="{Binding HasAxonSelection}" Spacing="6">
                <TextBlock Text="Axon Tuning" Classes="row-title" />
                <TextBlock Text="{Binding SelectedAxon.TargetLabel}" Classes="muted" />
                <Grid ColumnDefinitions="Auto,*,60" ColumnSpacing="8">
                  <TextBlock Text="Strength" VerticalAlignment="Center" />
                  <Slider Grid.Column="1" Minimum="0" Maximum="31" Value="{Binding SelectedAxon.StrengthCode}" />
                  <TextBox Grid.Column="2" Text="{Binding SelectedAxon.StrengthCode}" />
                </Grid>
              </StackPanel>
            </StackPanel>
          </Border>
        </Grid>

      </StackPanel>
    </ScrollViewer>
  </Border>
</UserControl>
