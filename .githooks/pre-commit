#!/usr/bin/env sh
set -eu

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

# Keep the existing Beads safety behavior in commit flow.
if command -v bd >/dev/null 2>&1 && [ -d .beads ]; then
    if ! bd sync --flush-only >/dev/null 2>&1; then
        echo "Error: Failed to flush bd changes to JSONL" >&2
        echo "Run 'bd sync --flush-only' manually to diagnose" >&2
        exit 1
    fi
    if [ -f .beads/issues.jsonl ]; then
        git add .beads/issues.jsonl 2>/dev/null || true
    fi
fi

run_docs_renderer() {
    if command -v pwsh >/dev/null 2>&1; then
        if pwsh -NoProfile -File ./tools/docs/render-nbnv2-docs.ps1 "$@"; then
            return 0
        fi
        echo "warning: pwsh docs render failed; trying fallback runner." >&2
    fi

    if command -v powershell.exe >/dev/null 2>&1; then
        if powershell.exe -NoProfile -ExecutionPolicy Bypass -File ./tools/docs/render-nbnv2-docs.ps1 "$@"; then
            return 0
        fi
        echo "warning: powershell.exe docs render failed; trying bash fallback." >&2
    fi

    bash ./tools/docs/render-nbnv2-docs.sh "$@"
}

run_docs_renderer

git add docs/NBNv2.md
